<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TriviaBot</title>
  <meta name="description" content="A sleek, adaptive AI trivia game" />
  <meta name="color-scheme" content="light dark" />

  <!-- Favicons (from snippet 1) -->
  <link rel="icon" type="image/webp" href="favicon_triviabot.webp" sizes="16x16">
  <link rel="icon" type="image/webp" href="favicon_triviabot.webp" sizes="32x32">
  <link rel="icon" type="image/webp" href="favicon_triviabot.webp" sizes="48x48">
  <link rel="apple-touch-icon" href="favicon_triviabot.webp">

  <!-- Optional fallback .ico -->
  <link rel="icon" href="/favicon.ico" />

  <!-- Early theme boot (prevents flash) -->
  <script>
    (function () {
      const saved = localStorage.getItem('theme'); // "light" | "dark" | null
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const theme = saved || (prefersDark ? 'dark' : 'light');
      document.documentElement.setAttribute('data-theme', theme);
    })();
  </script>

  <!-- CSS -->
  <link rel="stylesheet" href="styles.css" fetchpriority="high">
</head>
<body>
  <header class="site-header">
    <div class="wrap">
      <!-- Brand (uses your WebP logo from snippet 1) -->
      <a class="brand" href="/" aria-label="Trivia Bot home" style="display:flex;align-items:center;gap:.5rem;text-decoration:none">
        <img src="triviabot.webp" alt="TriviaBot Logo" width="80" height="80" decoding="async" />
        <span class="title">TriviaBot</span>
      </a>
      <nav class="nav">
        <button class="ghost small" id="reset">Reset</button>
        <!-- Theme toggle button -->
        <button id="themeToggle" class="ghost small" aria-pressed="false" title="Toggle theme">
          <span id="themeIcon" aria-hidden="true">☀︎</span>
          <span id="themeText">Light</span>
        </button>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <section class="intro card">
      <h1>TriviaBot</h1>
      <p class="lead">Pick a category and test your wits. Questions are generated on the fly.</p>

      <div class="categories" role="tablist" aria-label="Categories">
        <button class="chip" data-cat="general" aria-pressed="false">General</button>
        <button class="chip" data-cat="dictionary" aria-pressed="false">Dictionary</button>
        <button class="chip" data-cat="entertainment" aria-pressed="false">Entertainment</button>
        <button class="chip" data-cat="history" aria-pressed="false">History</button>
        <button class="chip" data-cat="food_drink" aria-pressed="false">Food &amp; Drink</button>
        <button class="chip" data-cat="geography" aria-pressed="false">Geography</button>
        <button class="chip" data-cat="science_nature" aria-pressed="false">Science &amp; Nature</button>
      </div>

      <div class="categories" role="tablist" aria-label="Difficulty" style="margin-top:10px">
        <span class="muted" style="align-self:center">Difficulty:</span>
        <button class="chip diff" data-diff="easy" aria-pressed="false">Easy</button>
        <button class="chip diff" data-diff="medium" aria-pressed="false">Medium</button>
        <button class="chip diff" data-diff="hard" aria-pressed="false">Hard</button>
      </div>
    </section>

    <section class="status-row">
      <div class="stat">Score: <strong id="score">0</strong></div>
      <div class="stat">Streak: <strong id="streak">0</strong></div>
      <div class="stat">Category: <strong id="catLabel">General</strong></div>
      <div class="stat">Difficulty: <strong id="diffLabel">Medium</strong></div>
      <div class="stat"><button id="newQ" class="primary">New Question</button></div>
    </section>

    <section id="game" class="card game">
      <div id="loader" class="loader" hidden aria-hidden="true" aria-busy="false">
        <div class="dots"><span></span><span></span><span></span></div>
        <div class="loader-text">THINKING</div>
      </div>

      <div id="qWrap" hidden>
        <h2 id="question" class="question" aria-live="polite"></h2>
        <ol id="choices" class="choices" role="listbox" aria-label="Answers"></ol>
        <div class="explain" id="explain" hidden></div>
        <div class="row">
          <button id="next" class="primary" disabled>Next</button>
        </div>
      </div>
    </section>

    <section class="tips">
      <p class="muted">Pro tip: Use button <kbd>1</kbd>-><kbd>4</kbd> to answer quickly. Your best score is saved on this device.</p>
    </section>
  </main>

  <footer class="site-footer">
    <div class="wrap">
      <small>© <span id="year"></span> TriviaBot • All Rights reserved</small>
    </div>
  </footer>

  <script>
  (function(){
    const scoreEl   = document.getElementById('score');
    const streakEl  = document.getElementById('streak');
    const catLabel  = document.getElementById('catLabel');
    const diffLabel = document.getElementById('diffLabel');
    const qWrap     = document.getElementById('qWrap');
    const qText     = document.getElementById('question');
    const choicesEl = document.getElementById('choices');
    const explainEl = document.getElementById('explain');
    const loader    = document.getElementById('loader');
    const nextBtn   = document.getElementById('next');
    const newQBtn   = document.getElementById('newQ');
    const resetBtn  = document.getElementById('reset');

    let score=0, streak=0, current={}, locked=false, category='general', difficulty='medium';
    let seen=[];

    try {
      const saved = JSON.parse(localStorage.getItem('quizgrid')||'{}');
      if (typeof saved.score === 'number')  score = saved.score;
      if (typeof saved.streak === 'number') streak = saved.streak;
      if (typeof saved.category === 'string') category = saved.category;
      if (typeof saved.difficulty === 'string') difficulty = saved.difficulty;
      if (Array.isArray(saved.seen)) seen = saved.seen;
    } catch(e){}

    function persist(){
      localStorage.setItem('quizgrid', JSON.stringify({score, streak, category, difficulty, seen}));
    }

    function setCategory(cat){
      category = cat;
      catLabel.textContent = labelFor(cat);
      document.querySelectorAll('.chip[data-cat]').forEach(ch => {
        const on = ch.dataset.cat === cat;
        ch.classList.toggle('active', on);
        ch.setAttribute('aria-pressed', on);
      });
      persist();
    }

    function setDifficulty(diff){
      difficulty = diff;
      diffLabel.textContent = diff[0].toUpperCase()+diff.slice(1);
      document.querySelectorAll('.chip.diff').forEach(ch => {
        const on = ch.dataset.diff === diff;
        ch.classList.toggle('active', on);
        ch.setAttribute('aria-pressed', on);
      });
      persist();
    }

    function labelFor(cat){
      switch(cat){
        case 'dictionary': return 'Dictionary';
        case 'entertainment': return 'Entertainment';
        case 'history': return 'History';
        case 'food_drink': return 'Food & Drink';
        case 'geography': return 'Geography';
        case 'science_nature': return 'Science & Nature';
        default: return 'General';
      }
    }

    function remember(q){
      if (!q) return;
      const t = q.trim();
      if (!t) return;
      seen.push(t);
      if (seen.length > 100) seen = seen.slice(-150);
      persist();
    }

    document.getElementById('year').textContent = new Date().getFullYear();

    document.querySelectorAll('.chip[data-cat]').forEach(btn => {
      btn.addEventListener('click', () => setCategory(btn.dataset.cat));
    });
    document.querySelectorAll('.chip.diff').forEach(btn => {
      btn.addEventListener('click', () => setDifficulty(btn.dataset.diff));
    });

    setCategory(category);
    setDifficulty(difficulty);

    scoreEl.textContent = score; streakEl.textContent = streak;

    resetBtn.addEventListener('click', () => {
      score=0; streak=0; seen=[]; persist();
      scoreEl.textContent=score; streakEl.textContent=streak;
    });

    function showLoader(show){
      loader.hidden = !show;
      loader.setAttribute('aria-hidden', show ? 'false' : 'true');
      loader.setAttribute('aria-busy', show ? 'true' : 'false');
      qWrap.hidden = show;
    }

    async function getQuestion(retry=0){
      nextBtn.disabled = true;
      explainEl.hidden = true;
      explainEl.textContent = '';
      choicesEl.innerHTML = '';
      qText.textContent = '';
      showLoader(true);
      locked=false;

      let ok = false;
      try {
        const recent = seen.slice(-75);
        const seed = Math.floor(Math.random()*1e9);
        const res = await fetch('/api/trivia', {
          method:'POST',
          headers:{'content-type':'application/json'},
          body: JSON.stringify({ category, difficulty, recent, seed })
        });
        const data = await res.json();

        if (recent.includes((data.question||'').trim()) && retry < 4) {
          return getQuestion(retry+1);
        }

        current = data;

        // Hide loader before painting the question
        showLoader(false);

        qText.textContent = data.question;
        data.choices.forEach((t,i)=>{
          const li = document.createElement('li');
          const btn = document.createElement('button');
          btn.className='choice';
          btn.textContent = `${i+1}. ${t}`;
          btn.setAttribute('data-i', i);
          btn.addEventListener('click', onAnswer);
          li.appendChild(btn);
          choicesEl.appendChild(li);
        });

        remember(data.question);
        ok = true;
      } catch (e){
        qText.textContent = "We couldn't fetch a question. Try again.";
        console.error(e);
      } finally {
        if (!ok) showLoader(false);
      }
    }

    function onAnswer(e){
      if (locked) return;
      locked = true;
      const i = +e.currentTarget.getAttribute('data-i');
      const correct = current.correct_index;
      const btns = [...document.querySelectorAll('.choice')];
      btns.forEach((b,idx)=>{
        if (idx===correct) b.classList.add('ok');
        if (idx===i && i!==correct) b.classList.add('bad');
        b.disabled = true;
      });
      if (i===correct){ score++; streak++; }
      else { streak=0; }
      scoreEl.textContent=score; streakEl.textContent=streak;
      explainEl.textContent = current.explanation || '';
      explainEl.hidden = !current.explanation;
      nextBtn.disabled = false;
      persist();
    }

    nextBtn.addEventListener('click', () => getQuestion());
    newQBtn.addEventListener('click', () => getQuestion());
    window.addEventListener('keydown', (e)=>{
      if (e.key>='1' && e.key<='4'){
        const idx = (+e.key)-1;
        const btn = document.querySelector(`.choice[data-i="${idx}"]`);
        if (btn) btn.click();
      } else if (e.key==='Enter' && !nextBtn.disabled){
        nextBtn.click();
      }
    });

    // Initial
    getQuestion();
  })();
  </script>

  <!-- Theme toggle logic -->
  <script>
    (function () {
      const root = document.documentElement;
      const btn  = document.getElementById('themeToggle');
      const icon = document.getElementById('themeIcon');
      const text = document.getElementById('themeText');

      function apply(theme){
        root.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
        const isDark = theme === 'dark';
        btn.setAttribute('aria-pressed', isDark);
        icon.textContent = isDark ? '☾' : '☀︎';
        text.textContent = isDark ? 'Dark' : 'Light';
      }

      // Initialize from attribute set in the head script
      apply(root.getAttribute('data-theme') || 'light');

      btn.addEventListener('click', () => {
        apply(root.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
      });
    })();
  </script>
</body>
</html>
